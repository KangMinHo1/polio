-- 1. MEMBERS 테이블
CREATE TABLE MEMBERS (
    MemberId NUMBER PRIMARY KEY,
    Email VARCHAR2(255 CHAR) NOT NULL UNIQUE
    Password VARCHAR2(255 CHAR) NOT NULL,
);

CREATE SEQUENCE SEQ_MEMBERS START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER TRG_MEMBERS_ID
BEFORE INSERT ON MEMBERS
FOR EACH ROW
WHEN (NEW.MemberId IS NULL)
BEGIN
    SELECT SEQ_MEMBERS.NEXTVAL INTO :NEW.MemberId FROM DUAL;
END;
/

-- 2. POST 테이블
CREATE TABLE POST (
    PostId NUMBER PRIMARY KEY,
    MemberId NUMBER NOT NULL,
    Title VARCHAR2(200 CHAR) NOT NULL,
    Content CLOB NOT NULL,
    ViewCount NUMBER DEFAULT 0,
    CreateDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    Category VARCHAR2(50 CHAR) NULL,
    CONSTRAINT fk_post_member FOREIGN KEY (MemberId) REFERENCES MEMBERS(MemberId)
);

CREATE SEQUENCE SEQ_POST START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER TRG_POST_ID
BEFORE INSERT ON POST
FOR EACH ROW
WHEN (NEW.PostId IS NULL)
BEGIN
    SELECT SEQ_POST.NEXTVAL INTO :NEW.PostId FROM DUAL;
END;
/

-- 3. POST_LIKES 테이블
CREATE TABLE POST_LIKES (
    PostId NUMBER NOT NULL,
    MemberId NUMBER NOT NULL,
    CONSTRAINT pk_post_likes PRIMARY KEY (PostId, MemberId),
    CONSTRAINT fk_like_post FOREIGN KEY (PostId) REFERENCES POST(PostId),
    CONSTRAINT fk_like_member FOREIGN KEY (MemberId) REFERENCES MEMBERS(MemberId)
);

-- 4. POST_COMMENT 테이블
CREATE TABLE POST_COMMENT (
    CommentId NUMBER PRIMARY KEY,
    PostId NUMBER NOT NULL,
    MemberId NUMBER NOT NULL,
    Contents CLOB NOT NULL,
    CreateDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_comment_post FOREIGN KEY (PostId) REFERENCES POST(PostId),
    CONSTRAINT fk_comment_member FOREIGN KEY (MemberId) REFERENCES MEMBERS(MemberId)
);

CREATE SEQUENCE SEQ_COMMENT START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER TRG_COMMENT_ID
BEFORE INSERT ON POST_COMMENT
FOR EACH ROW
WHEN (NEW.CommentId IS NULL)
BEGIN
    SELECT SEQ_COMMENT.NEXTVAL INTO :NEW.CommentId FROM DUAL;
END;
/

-- 5. CHATROOM 테이블
CREATE TABLE CHATROOM (
    RoomId NUMBER PRIMARY KEY,
    RoomName VARCHAR2(100 CHAR) NOT NULL,
    CreateDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE SEQUENCE SEQ_CHATROOM START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER TRG_CHATROOM_ID
BEFORE INSERT ON CHATROOM
FOR EACH ROW
WHEN (NEW.RoomId IS NULL)
BEGIN
    SELECT SEQ_CHATROOM.NEXTVAL INTO :NEW.RoomId FROM DUAL;
END;
/

-- 6. CHATROOM_MEMBER 테이블
CREATE TABLE CHATROOM_MEMBER (
    RoomId NUMBER NOT NULL,
    MemberId NUMBER NOT NULL,
    CONSTRAINT pk_chatroom_member PRIMARY KEY (RoomId, MemberId),
    CONSTRAINT fk_map_room FOREIGN KEY (RoomId) REFERENCES CHATROOM(RoomId),
    CONSTRAINT fk_map_member FOREIGN KEY (MemberId) REFERENCES MEMBERS(MemberId)
);

-- 7. CHAT_MESSAGE 테이블
CREATE TABLE CHAT_MESSAGE (
    ChatId NUMBER PRIMARY KEY,
    RoomId NUMBER NOT NULL,
    MemberId NUMBER NOT NULL,
    Content CLOB NOT NULL,
    SendDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_chat_room FOREIGN KEY (RoomId) REFERENCES CHATROOM(RoomId),
    CONSTRAINT fk_chat_member FOREIGN KEY (MemberId) REFERENCES MEMBERS(MemberId)
);

CREATE SEQUENCE SEQ_CHAT_MESSAGE START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER TRG_CHAT_MESSAGE_ID
BEFORE INSERT ON CHAT_MESSAGE
FOR EACH ROW
WHEN (NEW.ChatId IS NULL)
BEGIN
    SELECT SEQ_CHAT_MESSAGE.NEXTVAL INTO :NEW.ChatId FROM DUAL;
END;
/
